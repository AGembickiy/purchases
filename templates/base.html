<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}–°–∏—Å—Ç–µ–º–∞ –∑–∞–∫—É–ø–æ–∫{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <link href="{% load static %}{% static 'css/output.css' %}" rel="stylesheet">
    
    <!-- Vue.js Meta –¥–∞–Ω–Ω—ã–µ -->
    <script>
        window.DJANGO_DATA = {
            user: {% if user.is_authenticated %}{
                id: {{ user.id }},
                username: "{{ user.username|escapejs }}",
                first_name: "{{ user.first_name|escapejs }}",
                last_name: "{{ user.last_name|escapejs }}",
                email: "{{ user.email|escapejs }}",
                is_authenticated: true
            }{% else %}null{% endif %},
            company: {% if request.current_company %}{
                id: {{ request.current_company.id }},
                name: "{{ request.current_company.name|escapejs }}",
                slug: "{{ request.current_company.slug|escapejs }}"
            }{% else %}null{% endif %},
            csrf_token: "{{ csrf_token }}",
            api_base_url: "/api"
        };
    </script>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-neutral-50 text-neutral-900">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="main-header">
        <div class="flex items-center">
            {% if request.current_company %}
            <a href="{% url 'companies:dashboard' request.current_company.slug %}" 
               class="text-xl font-bold text-primary-600 hover:text-primary-700">
                {{ request.current_company.name }}
            </a>
            {% else %}
            <a href="{% url 'companies:select' %}" 
               class="text-xl font-bold text-primary-600 hover:text-primary-700">
                –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫—É–ø–æ–∫
            </a>
            {% endif %}
        </div>
        
        <div class="flex items-center space-x-4">
            {% if user.is_authenticated %}
                <span class="text-sm text-neutral-600">
                    {{ user.get_full_name|default:user.username }}
                </span>
                {% if request.current_company %}
                <a href="{% url 'company_users:logout' request.current_company.slug %}" 
                   class="btn btn-outline text-sm">
                    –í—ã–π—Ç–∏
                </a>
                {% else %}
                <a href="{% url 'legacy_users:logout' %}" 
                   class="btn btn-outline text-sm">
                    –í—ã–π—Ç–∏
                </a>
                {% endif %}
            {% else %}
                <a href="{% url 'companies:select' %}" 
                   class="btn btn-primary text-sm">
                    –í–æ–π—Ç–∏
                </a>
            {% endif %}
        </div>
    </nav>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Vue –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ Django –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div class="relative">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="{% if request.current_company %}main-content{% endif %}">
            <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è Vue.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
            <div id="app" class="hidden"></div>
            
            <!-- Django –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div id="django-content" class="page-container">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                {% if messages %}
                    <div class="mb-6">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags|default:'info' }} mb-4">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                {% block content %}{% endblock %}
            </div>
        </main>
        
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Å–ø—Ä–∞–≤–∞) -->
        {% if request.current_company %}
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="{% url 'companies:dashboard' request.current_company.slug %}" 
                   class="sidebar-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <span class="text-base">üìä</span>
                    <span class="ml-3">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                </a>
                
                <a href="{% url 'company_users:users_list' request.current_company.slug %}" 
                   class="sidebar-link {% if 'users' in request.resolver_match.url_name %}active{% endif %}">
                    <span class="text-base">üë•</span>
                    <span class="ml-3">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</span>
                </a>
                
                <a href="{% url 'company_orders:orders_list' request.current_company.slug %}" 
                   class="sidebar-link {% if 'orders' in request.resolver_match.url_name %}active{% endif %}">
                    <span class="text-base">üìã</span>
                    <span class="ml-3">–ó–∞–∫–∞–∑—ã</span>
                </a>
                
                <a href="{% url 'company_products:products_list' request.current_company.slug %}" 
                   class="sidebar-link {% if 'products' in request.resolver_match.url_name %}active{% endif %}">
                    <span class="text-base">üì¶</span>
                    <span class="ml-3">–¢–æ–≤–∞—Ä—ã</span>
                </a>
                
                <a href="{% url 'company_suppliers:suppliers_list' request.current_company.slug %}" 
                   class="sidebar-link {% if 'suppliers' in request.resolver_match.url_name %}active{% endif %}">
                    <span class="text-base">üè¢</span>
                    <span class="ml-3">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã</span>
                </a>
                
                <a href="{% url 'company_departments:departments_list' request.current_company.slug %}" 
                   class="sidebar-link {% if 'departments' in request.resolver_match.url_name %}active{% endif %}">
                    <span class="text-base">üèõÔ∏è</span>
                    <span class="ml-3">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</span>
                </a>
                
                <hr class="my-4 border-neutral-200">
                
                <a href="{% url 'companies:settings' request.current_company.slug %}" 
                   class="sidebar-link {% if request.resolver_match.url_name == 'settings' %}active{% endif %}">
                    <span class="text-base">‚öôÔ∏è</span>
                    <span class="ml-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </a>
                
                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –º–µ–Ω—é -->
                {% if custom_menu_sections %}
                    <hr class="my-4 border-neutral-200">
                    {% for section in custom_menu_sections %}
                    <a href="{{ section.get_full_url }}" 
                       class="sidebar-link"
                       {% if section.open_in_new_tab %}target="_blank"{% endif %}>
                        {% if section.icon %}
                            <span class="text-base">{{ section.icon }}</span>
                        {% else %}
                            <span class="text-base">üîó</span>
                        {% endif %}
                        <span class="ml-3">{{ section.title }}</span>
                    </a>
                    {% endfor %}
                {% endif %}
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤) -->
                {% if membership.has_full_admin_rights %}
                <hr class="my-4 border-neutral-200">
                <a href="{% url 'companies:manage_menu' request.current_company.slug %}" 
                   class="sidebar-link text-primary-600">
                    <span class="text-base">üîß</span>
                    <span class="ml-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</span>
                </a>
                {% endif %}
            </nav>
        </aside>
        {% endif %}
    </div>
    
    <!-- Vue.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
    {% block vue_app %}{% endblock %}
    
    <!-- JavaScript -->
    {% block extra_js %}{% endblock %}
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Vue.js –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ -->
    {% if debug %}
    <script type="module">
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å Vue –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const shouldLoadVue = document.querySelector('[data-vue-app]');
        if (shouldLoadVue) {
            import('/static/dist/js/main.js').then(() => {
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('django-content').classList.add('hidden');
            });
        }
    </script>
    {% else %}
    <!-- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ Vue.js –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏–∫—É -->
    <script>
        // –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Vue –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
        if (document.querySelector('[data-vue-app]')) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º Vue –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            const script = document.createElement('script');
            script.src = '{% static "dist/js/main.js" %}';
            script.onload = () => {
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('django-content').classList.add('hidden');
            };
            document.head.appendChild(script);
        }
    </script>
    {% endif %}
</body>
</html>
